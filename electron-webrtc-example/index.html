<!--
  ============================================================
  AIGuard Camera - Electron UI
  VERSION: 2.2.1 (2026-02-02)
  ============================================================
  
  CHANGELOG:
  - v2.2.1: Fixed monitoring initialization - proper IPC listener setup for camera start ACK
  - v2.2.0: Added renderer-monitoring.js script for motion/sound detection
  - v2.1.0: Disabled camera preflight check for Away Mode (LED fix)
  - v2.0.0: Full monitoring integration with motion/sound detection
  
  DEPENDENCIES: Electron preload.js, renderer-webrtc.js, renderer-monitoring.js
  ============================================================
-->
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIGuard Camera</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #e2e8f0;
      }

      .container {
        background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 40px;
        width: 420px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(71, 85, 105, 0.5);
        position: relative;
      }

      .header {
        text-align: center;
        margin-bottom: 28px;
      }

      .logo {
        font-size: 48px;
        margin-bottom: 12px;
      }

      h1 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #f1f5f9;
      }

      .subtitle {
        color: #94a3b8;
        font-size: 14px;
        line-height: 1.35;
      }

      .lang-toggle {
        position: absolute;
        top: 18px;
        right: 18px;
        display: flex;
        gap: 8px;
      }

      .lang-btn {
        padding: 8px 14px;
        border: 1px solid rgba(71, 85, 105, 0.5);
        background: rgba(30, 41, 59, 0.8);
        color: #94a3b8;
        border-radius: 10px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        user-select: none;
      }

      .lang-btn:hover {
        background: rgba(51, 65, 85, 0.8);
        color: #e2e8f0;
      }

      .lang-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: #ffffff;
      }

      .code-section {
        margin-bottom: 18px;
      }

      .code-label {
        display: block;
        margin-bottom: 12px;
        font-size: 13px;
        color: #cbd5e1;
        text-align: center;
      }

      .code-inputs {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 14px;
      }

      .code-input {
        width: 50px;
        height: 58px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        border: 2px solid rgba(71, 85, 105, 0.5);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.6);
        color: #f1f5f9;
        outline: none;
        transition: all 0.2s;
      }

      .code-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      }

      .paste-btn {
        width: 100%;
        padding: 12px;
        background: rgba(51, 65, 85, 0.6);
        border: 1px solid rgba(71, 85, 105, 0.5);
        color: #94a3b8;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        user-select: none;
      }

      .paste-btn:hover {
        background: rgba(71, 85, 105, 0.6);
        color: #e2e8f0;
      }

      .submit-btn,
      .minimize-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 700;
        transition: all 0.2s;
        margin-top: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        user-select: none;
      }

      .submit-btn:hover:not(:disabled),
      .minimize-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 22px rgba(59, 130, 246, 0.28);
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .error-message {
        background: rgba(239, 68, 68, 0.18);
        border: 1px solid rgba(239, 68, 68, 0.45);
        color: #fecaca;
        padding: 12px;
        border-radius: 10px;
        text-align: center;
        margin-top: 14px;
        font-size: 14px;
        display: none;
        line-height: 1.35;
      }

      .success-screen {
        display: none;
        text-align: center;
      }

      .success-icon {
        font-size: 64px;
        margin-bottom: 12px;
      }

      .success-title {
        font-size: 24px;
        font-weight: 800;
        color: #4ade80;
        margin-bottom: 8px;
      }

      .success-subtitle {
        color: #94a3b8;
        margin-bottom: 18px;
        line-height: 1.35;
      }

      .info-box {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.28);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
        text-align: start;
      }

      .info-box-title {
        font-weight: 800;
        color: #93c5fd;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .info-box-text {
        color: #cbd5e1;
        font-size: 13px;
        line-height: 1.55;
      }

      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .close-btn {
        width: 100%;
        padding: 14px;
        background: rgba(239, 68, 68, 0.18);
        border: 1px solid rgba(239, 68, 68, 0.45);
        color: #fecaca;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 800;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        user-select: none;
      }

      .close-btn:hover {
        background: rgba(239, 68, 68, 0.26);
      }

      .warning-text {
        color: #fbbf24;
        font-size: 12px;
        margin-top: 6px;
        text-align: center;
        line-height: 1.35;
      }

      .hint-text {
        color: #94a3b8;
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
        line-height: 1.35;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .live-indicator {
        display: none;
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 16px;
        text-align: center;
      }

      .live-indicator.active {
        display: block;
      }

      .live-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: #ef4444;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .live-text {
        color: #fecaca;
        font-weight: 700;
      }

      [dir="rtl"] .lang-toggle {
        right: auto;
        left: 18px;
      }

      [dir="rtl"] .info-box {
        text-align: right;
      }

      [dir="rtl"] .code-inputs {
        flex-direction: row-reverse;
      }

      [dir="rtl"] .info-box-title {
        flex-direction: row-reverse;
      }

      [dir="rtl"] .live-dot {
        margin-right: 0;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="lang-toggle">
        <button id="lang-en" class="lang-btn active" type="button">EN</button>
        <button id="lang-he" class="lang-btn" type="button">◊¢◊ë</button>
      </div>

      <div id="pairing-screen">
        <div class="header">
          <div class="logo">üõ°Ô∏è</div>
          <h1 id="title">Connect Camera</h1>
          <div class="subtitle" id="subtitle">Enter the 6-digit code from your dashboard</div>
        </div>

        <div class="code-section">
          <label class="code-label" id="code-label">Pairing Code</label>
          <div class="code-inputs" id="code-inputs">
            <input class="code-input" inputmode="numeric" maxlength="1" />
            <input class="code-input" inputmode="numeric" maxlength="1" />
            <input class="code-input" inputmode="numeric" maxlength="1" />
            <input class="code-input" inputmode="numeric" maxlength="1" />
            <input class="code-input" inputmode="numeric" maxlength="1" />
            <input class="code-input" inputmode="numeric" maxlength="1" />
          </div>

          <button class="paste-btn" id="paste-btn" type="button">üìã <span id="paste-text">Paste Code</span></button>
          <div class="hint-text" id="paste-hint">Tip: You can paste the full code and we will fill it automatically.</div>
        </div>

        <button class="submit-btn" id="connect-btn" type="button">Connect</button>
        <div class="error-message" id="error"></div>
      </div>

      <div id="success-screen" class="success-screen">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title" id="success-title">Connected Successfully</div>
        <div class="success-subtitle" id="success-subtitle">Your camera is now linked to your account</div>

        <!-- Away Mode Status -->
        <div id="away-mode-indicator" class="info-box" style="display: none; background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.4);">
          <div class="info-box-title" style="color: #86efac;"><span>üè†</span> <span id="away-mode-title">Away Mode Active</span></div>
          <div class="info-box-text" id="away-mode-text">Camera is monitoring. Display will turn off.</div>
        </div>

        <div id="live-indicator" class="live-indicator">
          <span class="live-dot"></span>
          <span class="live-text" id="live-text">LIVE - Streaming</span>
        </div>

        <div class="info-box">
          <div class="info-box-title"><span>‚ÑπÔ∏è</span> <span id="bg-title">Background Operation</span></div>
          <div class="info-box-text" id="bg-text">
            The camera will continue to work in the background even when this window is closed or minimized.
            To reopen the app, click the AIGuard icon near the clock.
          </div>
        </div>

        <div class="action-buttons">
          <button class="minimize-btn" id="minimize-btn" type="button">üîΩ <span id="minimize-text">Minimize to Background</span></button>
          <div>
            <button class="close-btn" id="exit-btn" type="button">‚õî <span id="exit-text">Exit Application</span></button>
            <div class="warning-text" id="exit-warning">Warning: Exiting will stop the camera service</div>
          </div>
        </div>
      </div>

      <!-- User Returned Modal removed - Away Mode is controlled manually from Dashboard -->
    </div>

    <!-- BUILD ID (debug)
         If you don't see this in the Electron console, you're not running
         this updated index.html file (or DevTools console is filtered). -->
    <script>
      console.log("[UI] index.html build: electron-index-2026-02-02-v2.2.1");
    </script>

    <!-- WebRTC logic (start/stop via IPC) -->
    <script src="renderer-webrtc.js"></script>

    <script>
      // ============================================================
      // BUILD ID (debug)
      // If you don't see this line in the Electron console, you're not
      // running the updated index.html file.
      // ============================================================
      const __ELECTRON_INDEX_BUILD_ID__ = "electron-index-2026-02-02-v2.2.1";
      console.log(`[UI] index.html build: ${__ELECTRON_INDEX_BUILD_ID__}`);
      
      // ============================================================
      // MONITORING SYSTEM - Inline initialization
      // The renderer-monitoring.js uses require() which doesn't work in browser.
      // Instead, we set up the monitoring IPC handlers directly here.
      // ============================================================
      (function initMonitoringHandlers() {
        console.log('[UI] Setting up monitoring IPC handlers...');
        
        let monitoringStream = null;
        let isMonitoring = false;
        
        // Listen for start monitoring command from main process
        if (window.electronAPI?.onStartMonitoring) {
          window.electronAPI.onStartMonitoring(async (config) => {
            console.log('[UI] Received START_MONITORING command:', config);
            
            if (isMonitoring) {
              console.log('[UI] Already monitoring, sending ACK');
              window.electronAPI.notifyMonitoringStarted?.({ motion: true, sound: false });
              return;
            }
            
            try {
              // Try to get camera access
              console.log('[UI] ◊û◊û◊™◊ô◊ü ◊ú◊û◊¶◊ú◊û◊î 1 - requesting getUserMedia...');
              monitoringStream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, frameRate: { ideal: 15 } },
                audio: false
              });
              
              console.log('[UI] ‚úì Camera stream obtained for monitoring');
              isMonitoring = true;
              
              // Send success ACK to main process
              window.electronAPI.notifyMonitoringStarted?.({ motion: true, sound: false });
              console.log('[UI] ‚úì Sent monitoring-started ACK to main');
              
            } catch (error) {
              console.error('[UI] ‚úó Camera access failed:', error.message);
              // Send error to main process
              window.electronAPI.notifyMonitoringError?.(error.message || 'Camera access denied');
            }
          });
          console.log('[UI] ‚úì onStartMonitoring listener registered');
        } else {
          console.warn('[UI] ‚ö†Ô∏è onStartMonitoring not available in electronAPI');
        }
        
        // Listen for stop monitoring command
        if (window.electronAPI?.onStopMonitoring) {
          window.electronAPI.onStopMonitoring(() => {
            console.log('[UI] Received STOP_MONITORING command');
            
            // Stop camera stream
            if (monitoringStream) {
              monitoringStream.getTracks().forEach(track => {
                track.stop();
                console.log('[UI] Stopped track:', track.kind);
              });
              monitoringStream = null;
            }
            
            isMonitoring = false;
            window.electronAPI.notifyMonitoringStopped?.();
            console.log('[UI] ‚úì Monitoring stopped, sent ACK');
          });
          console.log('[UI] ‚úì onStopMonitoring listener registered');
        }
        
        console.log('[UI] ‚úì Monitoring handlers initialized');
      })();
      // ============================================================
      // CONFIG (SUPABASE_URL is already defined in renderer-webrtc.js)
      // ============================================================

      // ============================================================
      // I18N
      // ============================================================
      const STRINGS = {
        en: {
          dir: "ltr",
          title: "Connect Camera",
          subtitle: "Enter the 6-digit code from your dashboard",
          codeLabel: "Pairing Code",
          pasteText: "Paste Code",
          pasteHint: "Tip: You can paste the full code and we will fill it automatically.",
          connect: "Connect",
          successTitle: "Connected Successfully",
          successSubtitle: "Your camera is now linked to your account",
          live: "LIVE - Streaming",
          bgTitle: "Background Operation",
          bgText:
            "The camera will continue to work in the background even when this window is closed or minimized.\nTo reopen the app, click the AIGuard icon near the clock.",
          minimize: "Minimize to Background",
          exit: "Exit Application",
          exitWarning: "Warning: Exiting will stop the camera service",
          errClipboard: "Could not read clipboard. Please paste the code manually.",
          errInvalid: "Please enter a 6-digit code.",
          errVerify: "Invalid or expired code.",
          errGeneric: "Something went wrong. Please try again.",
          connecting: "Connecting‚Ä¶",
          // Away Mode
          awayModeTitle: "Away Mode Active",
          awayModeText: "Camera is monitoring. Display will turn off.",
          userReturnedTitle: "Welcome Back",
          userReturnedMessage: "You have returned. Would you like to disable Away Mode?",
          disableAwayMode: "Disable Away Mode",
          keepAwayMode: "Keep Away Mode"
        },
        he: {
          dir: "rtl",
          title: "◊ó◊ô◊ë◊ï◊® ◊û◊¶◊ú◊û◊î",
          subtitle: "◊î◊ñ◊ü/◊ô ◊ß◊ï◊ì ◊ë◊ü 6 ◊°◊§◊®◊ï◊™ ◊û◊î◊ì◊©◊ë◊ï◊®◊ì",
          codeLabel: "◊ß◊ï◊ì ◊¶◊ô◊û◊ï◊ì",
          pasteText: "◊î◊ì◊ë◊ß ◊ß◊ï◊ì",
          pasteHint: "◊ò◊ô◊§: ◊ê◊§◊©◊® ◊ú◊î◊ì◊ë◊ô◊ß ◊ê◊™ ◊õ◊ú ◊î◊ß◊ï◊ì ◊ï◊ê◊†◊ó◊†◊ï ◊†◊û◊ú◊ê ◊ê◊ï◊™◊ï ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™.",
          connect: "◊î◊™◊ó◊ë◊®",
          successTitle: "◊ó◊ô◊ë◊ï◊® ◊î◊¶◊ú◊ô◊ó",
          successSubtitle: "◊î◊û◊¶◊ú◊û◊î ◊ß◊ï◊©◊®◊î ◊ú◊ó◊©◊ë◊ï◊ü ◊©◊ú◊ö",
          live: "LIVE - ◊©◊ô◊ì◊ï◊® ◊§◊¢◊ô◊ú",
          bgTitle: "◊§◊¢◊ô◊ú◊ï◊™ ◊ë◊®◊ß◊¢",
          bgText:
            "◊î◊û◊¶◊ú◊û◊î ◊™◊û◊©◊ô◊ö ◊ú◊¢◊ë◊ï◊ì ◊ë◊®◊ß◊¢ ◊í◊ù ◊ê◊ù ◊î◊ó◊ú◊ï◊ü ◊†◊°◊í◊® ◊ê◊ï ◊û◊û◊ï◊ñ◊¢◊®.\n◊õ◊ì◊ô ◊ú◊§◊™◊ï◊ó ◊©◊ï◊ë, ◊ú◊ó◊•/◊ô ◊¢◊ú ◊î◊ê◊ô◊ô◊ß◊ï◊ü ◊ú◊ô◊ì ◊î◊©◊¢◊ï◊ü.",
          minimize: "◊û◊ñ◊¢◊® ◊ú◊®◊ß◊¢",
          exit: "◊ô◊¶◊ô◊ê◊î ◊û◊î◊ê◊§◊ú◊ô◊ß◊¶◊ô◊î",
          exitWarning: "◊ê◊ñ◊î◊®◊î: ◊ô◊¶◊ô◊ê◊î ◊™◊¢◊¶◊ï◊® ◊ê◊™ ◊©◊ô◊®◊ï◊™ ◊î◊û◊¶◊ú◊û◊î",
          errClipboard: "◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ß◊®◊ï◊ê ◊û◊î◊ú◊ï◊ó. ◊†◊ê ◊ú◊î◊ì◊ë◊ô◊ß ◊ô◊ì◊†◊ô◊™.",
          errInvalid: "◊†◊ê ◊ú◊î◊ñ◊ô◊ü ◊ß◊ï◊ì ◊ë◊ü 6 ◊°◊§◊®◊ï◊™.",
          errVerify: "◊ß◊ï◊ì ◊ú◊ê ◊™◊ß◊ô◊ü ◊ê◊ï ◊§◊í ◊™◊ï◊ß◊£.",
          errGeneric: "◊û◊©◊î◊ï ◊î◊©◊™◊ë◊©. ◊†◊°◊î/◊ô ◊©◊ï◊ë.",
          connecting: "◊û◊™◊ó◊ë◊®‚Ä¶",
          // Away Mode
          awayModeTitle: "◊û◊¶◊ë ◊û◊®◊ï◊ó◊ß ◊§◊¢◊ô◊ú",
          awayModeText: "◊î◊û◊¶◊ú◊û◊î ◊ë◊û◊¶◊ë ◊†◊ô◊ò◊ï◊®. ◊î◊û◊°◊ö ◊ô◊õ◊ë◊î.",
          userReturnedTitle: "◊ë◊®◊ï◊ö ◊©◊ï◊ë◊ö",
          userReturnedMessage: "◊ó◊ñ◊®◊™ ◊î◊ë◊ô◊™◊î. ◊î◊ê◊ù ◊ú◊õ◊ë◊ï◊™ ◊ê◊™ ◊û◊¶◊ë ◊û◊®◊ï◊ó◊ß?",
          disableAwayMode: "◊õ◊ë◊î ◊û◊¶◊ë ◊û◊®◊ï◊ó◊ß",
          keepAwayMode: "◊î◊©◊ê◊® ◊û◊¶◊ë ◊û◊®◊ï◊ó◊ß"
        }
      };

      let currentLang = "en";

      function setLanguage(lang) {
        currentLang = lang;
        const t = STRINGS[lang];

        document.documentElement.lang = lang;
        document.documentElement.dir = t.dir;

        document.getElementById("lang-en").classList.toggle("active", lang === "en");
        document.getElementById("lang-he").classList.toggle("active", lang === "he");

        document.getElementById("title").textContent = t.title;
        document.getElementById("subtitle").textContent = t.subtitle;
        document.getElementById("code-label").textContent = t.codeLabel;
        document.getElementById("paste-text").textContent = t.pasteText;
        document.getElementById("paste-hint").textContent = t.pasteHint;
        document.getElementById("connect-btn").textContent = t.connect;

        document.getElementById("success-title").textContent = t.successTitle;
        document.getElementById("success-subtitle").textContent = t.successSubtitle;
        document.getElementById("live-text").textContent = t.live;
        document.getElementById("bg-title").textContent = t.bgTitle;
        document.getElementById("bg-text").textContent = t.bgText;
        document.getElementById("minimize-text").textContent = t.minimize;
        document.getElementById("exit-text").textContent = t.exit;
        document.getElementById("exit-warning").textContent = t.exitWarning;
      }

      // ============================================================
      // PAIRING UI HELPERS
      // ============================================================
      const codeInputs = Array.from(document.querySelectorAll(".code-input"));
      const errorEl = document.getElementById("error");
      const connectBtn = document.getElementById("connect-btn");
      const pasteBtn = document.getElementById("paste-btn");

      function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = "block";
      }

      function clearError() {
        errorEl.textContent = "";
        errorEl.style.display = "none";
      }

      function getCode() {
        return codeInputs.map((i) => (i.value || "").replace(/\D/g, "")).join("").slice(0, 6);
      }

      function setCode(code) {
        const digits = String(code || "")
          .replace(/\D/g, "")
          .slice(0, 6)
          .split("");

        for (let idx = 0; idx < codeInputs.length; idx++) {
          codeInputs[idx].value = digits[idx] || "";
        }

        const nextIndex = Math.min(digits.length, codeInputs.length - 1);
        codeInputs[nextIndex].focus();
      }

      async function readClipboardText() {
        // Electron usually supports navigator.clipboard in secure contexts,
        // but fallback to prompt for reliability.
        if (navigator.clipboard && navigator.clipboard.readText) {
          return navigator.clipboard.readText();
        }
        return null;
      }

      function showSuccessScreen() {
        document.getElementById("pairing-screen").style.display = "none";
        document.getElementById("success-screen").style.display = "block";
      }

      function setLiveIndicator(isLive) {
        document.getElementById("live-indicator").classList.toggle("active", !!isLive);
      }

      // ============================================================
      // INPUT BEHAVIOR (auto-advance, backspace)
      // ============================================================
      codeInputs.forEach((input, idx) => {
        input.addEventListener("input", (e) => {
          clearError();
          const v = String(e.target.value || "").replace(/\D/g, "");
          e.target.value = v.slice(-1);
          if (e.target.value && idx < codeInputs.length - 1) {
            codeInputs[idx + 1].focus();
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && idx > 0) {
            codeInputs[idx - 1].focus();
          }
          if (e.key === "Enter") {
            connectBtn.click();
          }
        });

        input.addEventListener("paste", (e) => {
          const text = (e.clipboardData || window.clipboardData)?.getData("text") || "";
          const digits = text.replace(/\D/g, "").slice(0, 6);
          if (digits.length) {
            e.preventDefault();
            setCode(digits);
          }
        });
      });

      pasteBtn.addEventListener("click", async () => {
        clearError();
        const t = STRINGS[currentLang];
        try {
          const text = (await readClipboardText()) || prompt(t.pasteText) || "";
          const digits = String(text).replace(/\D/g, "").slice(0, 6);
          if (!digits) {
            showError(t.errClipboard);
            return;
          }
          setCode(digits);
        } catch (e) {
          showError(t.errClipboard);
        }
      });

      // ============================================================
      // PAIRING (Edge Function)
      // ============================================================
      async function verifyPairingCode(code) {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/verify-pairing-code`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const err = data?.error || "verify_failed";
          throw new Error(err);
        }
        return data;
      }

      connectBtn.addEventListener("click", async () => {
        clearError();
        const t = STRINGS[currentLang];

        const code = getCode();
        if (code.length !== 6) {
          showError(t.errInvalid);
          return;
        }

        const originalText = connectBtn.textContent;
        connectBtn.disabled = true;
        connectBtn.textContent = t.connecting;

        try {
          const data = await verifyPairingCode(code);

          // IMPORTANT: keep snake_case for IPC sync
          console.log('[UI] Pairing verified. electronAPI.loginUser available:', !!window.electronAPI?.loginUser);

          if (window.electronAPI?.loginUser) {
            console.log('[UI] Sending login-user IPC to main...', {
              profile_id: data.profile_id,
              device_id: data.device_id,
              has_session_token: !!data.session_token,
            });
            window.electronAPI.loginUser({
              profile_id: data.profile_id,
              session_token: data.session_token,
              device_id: data.device_id,
            });
          } else {
            console.warn(
              '[UI] WARNING: electronAPI.loginUser is missing. Main process will NOT receive profile_id/device_id, so Auto-Away cannot run.'
            );
          }

          showSuccessScreen();
        } catch (e) {
          const msg = String(e?.message || "");
          if (msg.toLowerCase().includes("invalid") || msg.toLowerCase().includes("expired")) {
            showError(t.errVerify);
          } else {
            showError(t.errGeneric);
          }
        } finally {
          connectBtn.disabled = false;
          connectBtn.textContent = originalText;
        }
      });

      // ============================================================
      // SUCCESS SCREEN ACTIONS
      // ============================================================
      document.getElementById("minimize-btn").addEventListener("click", () => {
        window.electronAPI?.minimizeToTray?.();
      });

      document.getElementById("exit-btn").addEventListener("click", () => {
        window.electronAPI?.exitApp?.();
      });

      // ============================================================
      // IPC -> UI live indicator (NOTE: actual WebRTC logic is in renderer-webrtc.js)
      // ============================================================
      // DO NOT register onStartLiveView/onStopLiveView here - it would override 
      // the WebRTC handlers in renderer-webrtc.js. The UI indicator is now 
      // handled via a separate approach if needed.

      // Allow main process to switch to success screen (auto-login)
      if (window.electronAPI?.onShowSuccessScreen) {
        window.electronAPI.onShowSuccessScreen(() => {
          showSuccessScreen();
        });
      }

      // ============================================================
      // AWAY MODE UI HANDLERS
      // ============================================================
      const awayModeIndicator = document.getElementById("away-mode-indicator");

      function setAwayModeIndicator(active) {
        if (awayModeIndicator) {
          awayModeIndicator.style.display = active ? "block" : "none";
        }
      }

      // Away Mode IPC listeners
      if (window.electronAPI) {
        window.electronAPI.onAwayModeEnabled?.(() => {
          console.log("[UI] Away Mode enabled");
          setAwayModeIndicator(true);
        });

        window.electronAPI.onAwayModeDisabled?.(() => {
          console.log("[UI] Away Mode disabled");
          setAwayModeIndicator(false);
        });

        window.electronAPI.onAwayModePreflightFailed?.((errors) => {
          console.log("[UI] Away Mode preflight failed:", errors);
          setAwayModeIndicator(false);
          // Could show error toast here
        });

        // User returned modal removed - Away Mode controlled from Dashboard

        // Camera check listener - DISABLED in v2.1.0
        // Away Mode does NOT require camera access. This listener is kept
        // for backward compatibility but will always return false without
        // actually accessing the camera hardware.
        window.electronAPI.onAwayModeCheckCamera?.(async () => {
          console.log("[UI] Camera check requested (IGNORED - camera not needed for Away Mode)");
          // IMPORTANT: Do NOT call getUserMedia here!
          // Always return false - camera check is no longer needed for Away Mode.
          window.electronAPI.sendCameraCheckResult(false);
        });

        // DEBUG: Power blocker status - will show in DevTools console
        if (typeof window.electronAPI.onPowerBlockerStatus === 'function') {
          console.log('[UI] PowerBlocker listener registered');
          window.electronAPI.onPowerBlockerStatus((data) => {
          console.log(`[UI] üîã POWER BLOCKER: ${data.status} (id: ${data.id})`);
          if (data.status === 'STOPPED') {
            console.log('[UI] ‚úÖ Power save blocker STOPPED - system CAN now sleep');
          } else if (data.status === 'STARTED') {
            console.log('[UI] ‚ö° Power save blocker ACTIVE - system will NOT sleep');
          } else if (data.status === 'ALREADY_NULL') {
            console.log('[UI] ‚ÑπÔ∏è Power save blocker was already stopped');
          }
          });
        } else {
          console.warn('[UI] ‚ö†Ô∏è onPowerBlockerStatus is MISSING on window.electronAPI (preload.js not updated / not loaded)');
        }
      }

      // User Returned Modal removed - Away Mode controlled manually from Dashboard

      // ============================================================
      // INIT
      // ============================================================
      setLanguage("en");
      document.getElementById("lang-en").addEventListener("click", () => setLanguage("en"));
      document.getElementById("lang-he").addEventListener("click", () => setLanguage("he"));
      codeInputs[0]?.focus();
    </script>
  </body>
</html>
